# Medagg Project (backend)

Medagg is a project focused on providing simple and efficient tools to search datasets gathered across multiple open sources
and to generate new ones from already existing. 

----

## Setup

Follow steps below to get the app run locally on your machine.

### 1. Get the project

- Clone the repo:
> [!WARNING]
>
> The following `git clone` will work only if your SSH-agent is active and you have generated access token in GitHub account settings,
> if not use can use this command instead:
> ```sh
> git clone -b devel https://github.com/ESBehtev/medagg-backend.git medagg-backend && cd medagg-backend/ 
> ```
```sh
git clone -b devel git@github.com:ESBehtev/medagg-backend.git medagg-backend && cd medagg-backend/
```

### 2. Start the app

Once you've prepared the project envirnemnt you can now start the app.

> [!IMPORTANT]
>
> Currently, project requires manual creation of `.env` files to work with the project.
> See [**Environment**](#environment-variables) section on what variables are required and where these files should be placed.

- Run configuration script:
```sh
python configure.py --docker
```

### 3. Ready to develop

If previous steps went successfully then you are now able to:

- **Connect to the database.** If you configured project with `--docker` option then you should be able to use web-interface called [adminer](https://www.adminer.org/). Choose `PostgreSQL` as `System`, use `db` for `Server` and fill the reset of the fields with database's credentials.
- **Access the app.** Open [localhost](localhost:8000/api/v1)

----

## Endpoints

> [!CAUTION]
>
> Project is still in active development, so this section might change too.

1. Root urls:
  - `/` - root page (404);
  - `/admin` - admin page generated by [Django](https://docs.djangoproject.com/en/5.2/ref/contrib/admin/);
  - `/api-auth` - authorization page generated by [django-rest-framework](https://www.django-rest-framework.org/api-guide/authentication/).

2. Home urls:
  - `/api/v1` - home page (404);
  - `/api/v1/datasets` - home page for datasets ([CRUD](https://ru.hexlet.io/courses/http-api/lessons/crud/theory_unit));
  - `/api/v1/users` - home page for users (CRUD);
  - `/api/v1/search` - home page for search engine (only POST):
    - `/datasets` - search engine for datasets;

### JSON Schemas

<details><summary> GET /api/v1/datasets </summary>

```http
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

[
    {
        "id": 1,
        "title": "...",
        "description": "...",
        "external_path": null,
        "local_path": null,
        "record_count": null,
        "size": null,
        "license": "...",
        "anatomical_area": 1,
        "anatomical_area_name": "...",
        "modalities": [],
        "ml_tasks": [],
        "tags": [],
        "created_at": "...",
        "updated_at": "..."
    }
]
```

</details>

<details><summary> GET /api/v1/datasets/{id} </summary>

```http
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

{
    "id": 1,
    "title": "...",
    "description": "...",
    "external_path": null,
    "local_path": null,
    "record_count": null,
    "size": null,
    "license": "...",
    "anatomical_area": 1,
    "anatomical_area_name": "...",
    "modalities": [],
    "ml_tasks": [],
    "tags": [],
    "created_at": "...",
    "updated_at": "..."
}
```

</details>

<details><summary> GET /api/v1/search/datasets (405) </summary>

```http
Allow: POST, OPTIONS
Content-Type: application/json
Vary: Accept

{
    "detail": "Method \"GET\" not allowed."
}
```

</details>

<details><summary> POST /api/v1/search/datasets </summary>

**Request**:
```http
Content-Type: application/json

{
    "query": "..."
}
```

**Response**:
```http
Allow: POST, OPTIONS
Content-Type: application/json
Vary: Accept

{
    "count": 1,
    "results": [
        {
            "id": 1,
            "title": "...",
            "description": "...",
            "external_path": null,
            "local_path": null,
            "record_count": null,
            "size": null,
            "license": "...",
            "anatomical_area": 1,
            "anatomical_area_name": "...",
            "modalities": [],
            "ml_tasks": [],
            "tags": [],
            "created_at": "...",
            "updated_at": "..."
        }
    ]
}
```

</details>

----

## Project structure

This section is about general project structure with detailed description of each directory.

```sh
medagg-backend/
├── .env/
├── db/
│   ├── data/
│   ├── config/
│   └── init/
└── src/
    ├── apps/
    │   ├── datasets/
    │   │   ├── api/
    │   │   │   └── v1/
    │   │   ├── tests/
    │   │   └── migrations/
    │   ├── search/
    │   │   ├── api/
    │   │   │   └── v1/
    │   │   └── tests/
    │   └── users/
    │       ├── api/
    │       │   └── v1/
    │       ├── tests/
    │       └── migrations/
    ├── libs/
    ├── common/
    └── config/
```

> [!NOTE]
>
> Some of the listed above directories may not be present,
> this may be due to the fact that they are created during project build
> and/or are not suppose to be a part of this repository (e.g. `.env/`).

### Environment

Directory in project root: `.env/`.

> [!IMPORTANT]
>
> Files in this directory are required for project to work properly. If at least one of the variable is skipped
> it might lead to an error during configuration, or even worse - cause an unexpected behaviour.
> So they must always be present and contain neccessary env variables!

Contains `.env` files that store environment variables for the project.

<details><summary> More about files in this directory. </summary>

General format of variables inside these files is `<NAME>=<value>`, where `<NAME>` is an uppercased name of the environment variable
and `<value>` is a raw-string (no quotes) value of the variable.

<a name="environment-variables"></a>
Files that are checked and used if present (used in `src/config/settings.py`, `docker-compose.yml`):
- `settings.env` - stores the general envirnonment varibales for DJango project. Variables inside:
  - `DJANGO_SECRET_KEY` - string representation of a [secret key for Django](https://docs.djangoproject.com/en/5.2/ref/settings/#secret-key) for [cryptographic signing](https://docs.djangoproject.com/en/5.2/topics/signing/);
  - `DJANGO_DEBUG_MODE` - boolean that turns on and off [debug mode](https://docs.djangoproject.com/en/5.2/ref/settings/#debug);
  - `DJANGO_ALLOWED_HOSTS` - list of host/domain names <ins>separated by the comma</ins> that this Django app can serve;
  - `DJANGO_SUPERUSER_USERNAME` - string representation of a password for [Django's superuser](https://docs.djangoproject.com/en/5.2/ref/django-admin/#createsuperuser);
  - `DJANGO_SUPERUSER_EMAIL` - string representation of superuser's email address;
  - `DJANGO_SUPERUSER_PASSWORD` - string representation of superuser's username;
  - `DJANGO_SUPERUSER_DATABASE` - string representation of a database into which the superuser object will be saved;
- `database.env` - stores database configurational variables like name, port, etc. Variables inside:
  - `DB_ENGINE` - string name of an [engine](https://docs.djangoproject.com/en/5.2/ref/settings/#engine) used by Django for database connection (use only the last identifier, e.g. `postgresql`, `sqlite3`, etc.);
  - `DB_HOST` - string [host](https://docs.djangoproject.com/en/5.2/ref/settings/#host) to use when connecting to the database;
  - `DB_PORT` - numeric [port](https://docs.djangoproject.com/en/5.2/ref/settings/#port) to use when connecting to the database;
  - `DB_NAME` - string [name](https://docs.djangoproject.com/en/5.2/ref/settings/#name) of the database to use;
  - `DB_USER` - string [username](https://docs.djangoproject.com/en/5.2/ref/settings/#user) to use when connecting to the database;
  - `DB_PASSWORD` - string [password](https://docs.djangoproject.com/en/5.2/ref/settings/#password) to use when connecting to the database;
  - `POSTGRES_USER` - string username for the specific implementation (for now, defaults to `DB_USER`);
  - `POSTGRES_PASSWORD` - string password for the specific implementation (for now, defaults to `DB_PASSWORD`);
  - `POSTGRES_DB` - string name of a database for the specific implementation (for now, defaults to `DB_NAME`);

</details>

### Database

Directory in project root: `db/`.

Contains 3 main directories inside:
1. `data` - this is where the data is kept after successful PostgreSQL initialization (created automatically, removed every time `./configure` script is ran);
2. `config` - stores PostgreSQL configuration files (e.g. `pg_hba.conf`);
3. `init` - contains `.sql` scripts taht are ran on PostgreSQL initialization.

### Source

Directory in project root: `src/`.

This is the main directory of a project splitted in 3 main parts:
1. `apps` - every app is stored in here. When crerating a new [Django app](https://docs.djangoproject.com/en/5.2/ref/django-admin/#startapp) this should be a destination directory (or just `cd` into it). For more about app structure see [App](#app) section;
2. `libs` - custom 3rd-party libraries are stored in here;
3. `common` - optional directory containing common "stuff" for the entire project (e.g. constants, generics, etc.);
4. `config` - directory for the project configuration files, including the primary URL file.

> [!TIP]
>
> Since the `manage.py` file is kept here, you can ommit `src` prefix when importing Python packages.
> For example, instead of `import src.apps.datasets.service ...` you can write `import apps.datasets.service ...`.

### App

Source directory relative to project root: `src/apps/`.

Contains all app-specific code, allowing for easy plug-and-play functionality.

Each app follows a consistent structure for models, views, serializers, etc.

Each app should be designed in way to be plug-able, that is, dragged and dropped into any other project and it’ll work independently.

Here is the main template for the app (can differ depending on specific app functionality):

1. Layers:
  - **Presentation**. Houses API components for each app, promoting organization and versioning. Contains files, like `urls.py`, `views.py` and `serializers.py`;
  - **Service**. Business logic is centralized within service modules to maintain separation of concerns. Represented by a single `services.py` file;
  - **Model** (Repository). A model is the single, definitive source of information about data. It contains the essential fields and behaviors of the storing storing data. Represented by a single `models.py` file.
2. Additional components:
  - **Migrations**. All migrations are stored and handled by Django, so their storage should be handed over to the automated tools, lile `makemigrations <app>`;
  - **Test**. Same as with migrations that are managed by the Django's autotooling.

